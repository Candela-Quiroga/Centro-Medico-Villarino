<!--editarUsuario.ejs-->
<!DOCTYPE html>
<html lang="en">
    <%- include('../commons/head')%>
    <body>
        <h1>Listado de usuarios</h1>
        <div class="container">
            <p id="usuario_id"><%=usuario.id%></p>
            <div>
                <label>Nombre</label>
                <input id="usuario_nombre" value="<%= usuario.nombre %>">

                <label>Email</label>
                <input id="usuario_email" value="<%= usuario.email %>">

                <label>Password</label>
                <input id="usuario_password" type="password" value="<%= usuario.id === 0 ? '':'*******' %>">

                <label>Categoria</label>
                <select id="usuario_categoria"> <!--Estamos obteniendo las categorias en un condicional-->
                    <% categorias.forEach((category) => { %>
                        <option value="<%= category.id %>" <%= (category.id == usuario.id_categoriaPermiso) ? 'selected' : '' %> >
                            <%= category.nombre %>
                        </option>
                    <% }) %>
                </select>            
                <button class="guardar">Guardar Usuario</button>
                <a href="/usuarios">Cancelar</a>
            </div>
        </div>
        <script>
            
            const botonGuardar = document.querySelector(".guardar");

            const usuarioNombre = document.querySelector("#usuario_nombre");
            const usuarioEmail = document.querySelector("#usuario_email");
            const usuarioPassword = document.querySelector("#usuario_password");
            const usuarioCategoria = document.querySelector("#usuario_categoria");

            botonGuardar.addEventListener("click", async () => {
                const datos = {
                    id: "<%= usuario.id %>",
                    nombre: usuarioNombre.value,
                    email: usuarioEmail.value,
                    password: usuarioPassword.value || undefined, //esto es para que no envíe contraseña vacía,
                    id_categoriaPermiso: usuarioCategoria.value
                };
                if (!usuarioNombre.value || !usuarioEmail.value || !usuarioCategoria.value) { //acá valido que ingresen todos los campos
                    alert("Todos los campos son requeridos.");
                    return;
                }
                const result = await fetch(`/usuario/${datos.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(datos),
                    headers: {
                        'Content-Type': 'application/json' //si no lo hacemos de esta forma, todos los datos que queramos recibir, van a estar mal.
                    }
                });
                const data = await result.json();
                if (data.success) { 
                    alert ("Usuario guardado correctamente");
                    location.href = "/usuarios";  //si toda la acutalización es correcta, volve al inicio
                } else { //si la actualización fue incorrecta
                    alert ("No se pudieron actualizar los valores"); //envia una alerta
                }
            });
        </script>
    </body>
</html>